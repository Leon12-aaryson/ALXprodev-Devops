#!/bin/bash

# Summarize Pok√©mon Data - Task 3
# Reads JSON files and generates CSV report with statistics

# Check if pokemon_data directory exists
if [ ! -d "pokemon_data" ]; then
    echo "‚ùå Error: pokemon_data directory not found. Please run the batch processing script first."
    exit 1
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    echo "‚ùå Error: jq command not found. Please install jq."
    exit 1
fi

# Check if sed is available
if ! command -v sed &> /dev/null; then
    echo "‚ùå Error: sed command not found. Please install sed."
    exit 1
fi

# Initialize variables for calculations
total_height=0
total_weight=0
count=0

# Create CSV header
echo "Name,Height (m),Weight (kg)" > pokemon_report.csv

echo "üìä Generating Pok√©mon data summary..."

# Process each JSON file in the pokemon_data directory
for json_file in pokemon_data/*.json; do
    if [ -f "$json_file" ]; then
        # Extract Pok√©mon name from filename
        pokemon_name=$(basename "$json_file" .json)
        
        # Extract height and weight using jq
        height=$(jq -r '.height' "$json_file" 2>/dev/null)
        weight=$(jq -r '.weight' "$json_file" 2>/dev/null)
        
        # Check if data extraction was successful
        if [ "$height" != "null" ] && [ "$weight" != "null" ]; then
            # Convert height from decimeters to meters
            height_m=$(echo "scale=2; $height / 10" | bc -l 2>/dev/null || echo "$(($height / 10)).$((($height % 10)))")
            
            # Convert weight from hectograms to kilograms
            weight_kg=$(echo "scale=2; $weight / 10" | bc -l 2>/dev/null || echo "$(($weight / 10)).$((($weight % 10)))")
            
            # Clean and format data using sed
            height_m=$(echo "$height_m" | sed 's/^0*//' | sed 's/^\./0./')
            weight_kg=$(echo "$weight_kg" | sed 's/\.0*$//')
            
            # Capitalize first letter of name using awk
            name_capitalized=$(echo "$pokemon_name" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
            
            # Add to CSV
            echo "$name_capitalized,$height_m,$weight_kg" >> pokemon_report.csv
            
            # Add to totals for average calculation
            total_height=$(echo "$total_height + $height_m" | bc -l 2>/dev/null || echo "$(($total_height + ${height_m%.*}))")
            total_weight=$(echo "$total_weight + $weight_kg" | bc -l 2>/dev/null || echo "$(($total_weight + ${weight_kg%.*}))")
            count=$((count + 1))
        fi
    fi
done

# Calculate averages using awk
if [ $count -gt 0 ]; then
    avg_height=$(echo "scale=2; $total_height / $count" | bc -l 2>/dev/null || echo "0")
    avg_weight=$(echo "scale=2; $total_weight / $count" | bc -l 2>/dev/null || echo "0")
    
    # Format averages using sed for cleaner output
    avg_height=$(echo "$avg_height" | sed 's/^0*//' | sed 's/^\./0./')
    avg_weight=$(echo "$avg_weight" | sed 's/\.0*$//')
    
    echo "CSV Report generated at: pokemon_report.csv"
    echo ""
    
    # Display the CSV content with sed formatting for better readability
    cat pokemon_report.csv | sed 's/,/, /g'
    
    echo ""
    echo "üìä Statistics Summary:"
    echo "Average Height: $avg_height m"
    echo "Average Weight: $avg_weight kg"
    echo "Total Pok√©mon processed: $count"
else
    echo "‚ùå No valid data found to process"
    exit 1
fi
